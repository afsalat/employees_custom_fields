{% extends 'dashboard/dashboard.html' %}

{% block content %}
<h2>Drag and Drop Custom Fields</h2>
<div class="fields-container">
    <!-- Field options -->
    <div class="field-options">
        <h3>Field Options</h3>
        <div class="field-option" draggable="true" id="employee-name">Number</div>
        <div class="field-option" draggable="true" id="employee-id">Text</div>
        <div class="field-option" draggable="true" id="department">Date</div>
        <div class="field-option" draggable="true" id="password">Password</div>
    </div>

    <!-- Empty div to drop fields -->
    <div class="empty-div">
        <h3>Drag Fields Here</h3>
    </div>
</div>

<!-- Save Button -->
<button id="save-btn">Save Fields</button>

<script>
    document.getElementById('save-btn').addEventListener('click', () => {
        // Collect the data from the dropped fields
        const fields = document.querySelectorAll('.field-container');
        const fieldData = [];

        fields.forEach(field => {
            // Get the label text, with fallback if no label is found
            const label = field.querySelector('label') ? field.querySelector('label').textContent : 'Unnamed Field';

            // Get the input or select element within the field
            const input = field.querySelector('input') || field.querySelector('select');

            // If neither input nor select is found, log an error and skip this field
            if (!input) {
                console.error('No input or select found in the field');
                return; // Skip this field
            }

            const fieldType = input.tagName.toLowerCase();  // 'input' or 'select'

            let options = '';
            if (fieldType === 'select') {
                // Gather the selected options for a select field
                options = Array.from(input.options)
                    .map(option => option.value)
                    .join(',');
            }

            // Push the field data to the array
            fieldData.push({
                label: label,
                field_type: fieldType,
                options: options,
            });
        });

        // Send the data to Django using AJAX
        fetch('http://127.0.0.1:8000/create-custom-field/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),  // CSRF token for security
            },
            body: JSON.stringify({ fields: fieldData }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Fields saved successfully!');
            } else {
                alert('Error saving fields');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the fields');
        });
    });

    // Get CSRF token (for security)
    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        return csrfToken;
    }

    // Select all draggable field options and the empty div
    const fields = document.querySelectorAll('.field-option');
    const emptyDiv = document.querySelector('.empty-div');

    // Add dragstart event listener to each field option
    fields.forEach(field => {
        field.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', field.textContent);
            field.classList.add('dragging');
        });

        field.addEventListener('dragend', () => {
            field.classList.remove('dragging');
        });
    });

    // Allow the empty div to accept dragged items
    emptyDiv.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    emptyDiv.addEventListener('drop', (e) => {
        e.preventDefault();
        const data = e.dataTransfer.getData('text/plain');

        // Create a container for the dropped field with label and input
        const fieldContainer = document.createElement('div');
        fieldContainer.classList.add('field-container');

        // Create the label and input based on the field name
        const label = document.createElement('label');
        label.textContent = data;

        let input;
        if (data === "Department") {
            input = document.createElement('select');
            const option1 = document.createElement('option');
            option1.value = "HR";
            option1.textContent = "HR";
            const option2 = document.createElement('option');
            option2.value = "Engineering";
            option2.textContent = "Engineering";
            input.appendChild(option1);
            input.appendChild(option2);
        } else if (data === "Date") {
            input = document.createElement('input');
            input.type = "date";
        } else if (data === "Password") {
            input = document.createElement('input');
            input.type = "password";
        } else {
            input = document.createElement('input');
            input.type = "text";
        }

        // Append the label and input to the field container
        fieldContainer.appendChild(label);
        fieldContainer.appendChild(input);

        // Append the field container to the empty div
        emptyDiv.appendChild(fieldContainer);
    });
</script>

<style>
    .fields-container {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .field-options {
        width: 40%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .field-option {
        margin: 10px 0;
        padding: 8px;
        background-color: #e4e4e4;
        border-radius: 5px;
        cursor: pointer;
    }

    .empty-div {
        width: 55%;
        padding: 10px;
        border: 1px dashed #ccc;
        border-radius: 5px;
        background-color: #f1f1f1;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .field-container {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
        width: 100%;
    }

    .field-container label {
        width: 30%;
        font-weight: bold;
    }

    .field-container input, .field-container select {
        width: 60%;
        padding: 5px;
        border-radius: 3px;
        border: 1px solid #ccc;
    }
</style>

{% endblock %}
